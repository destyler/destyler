<!-- Generated by SpecStory, Markdown v2.0.0 -->

<!-- vscode Session 0e4e5772-6a52-4917-b6f3-b9d60befe63c (2025-11-14 02:23Z) -->

# 测试案例无法通过的原因分析 (2025-11-14 02:23Z)

_**User (2025-11-14 02:25Z)**_

但是我们的 `content should not be reachable via tab key` 这个测试案例为什么无法通过

---

_**Agent (model copilot/gpt-5-codex)**_

**Investigating failing test focus behavior****Searching collapsible component code****Inspecting dataset usage in components****Opening src directory****Verifying connection****Analyzing focus and hidden attribute behavior****Analyzing failing tab key test****Analyzing focus and animation interaction****定位原因**
- 在`connect.ts`里，内容面板的`hidden`属性只会在`state.matches('open', 'closing')`为`false`时才设置；当触发第二次点击进入`closing`状态时，`visible`仍为`true`以便播放收起动画，因此该阶段`hidden`仍为`false`。
- 测试中在第二次点击后立刻执行了`userEvent.tab()`；此时动画尚未结束，DOM 里 `<a href="#">` 仍处于可聚焦状态，焦点会先跳到它而不是控件区的 “Open” 按钮，断言因此失败。
- 如果等待动画发送`ANIMATION.END`并让状态进入`closed`，焦点就会按照预期跳到“Open”按钮。

**可选方案**
1. 在组件层面，于`closing`状态就让内容不可聚焦（例如临时加上`inert`或`aria-hidden`+`tabindex=-1`），确保收起动画期间也阻止 Tab 导航。
2. 在测试里等待收起动画结束（比如监听 `page.waitFor` 某个属性变化或显式等待 `contentEl.hidden` 为 `true`）后再触发 `tab()`。

你可以根据更符合产品期望的行为选择其一，或先加等待验证现象。

---

